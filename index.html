<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Vendas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.css">
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/1.1.2/css/bootstrap-multiselect.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/1.1.2/js/bootstrap-multiselect.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #0E1117; color: #FAFAFA; margin: 0; padding: 20px; }
        .container { display: grid; grid-template-columns: repeat(12, 1fr); grid-gap: 20px; }
        .header, .filters, .kpi-container, .chart-container, .table-container { grid-column: span 12; background-color: #161B22; padding: 20px; border-radius: 10px; border: 1px solid #30363D; }
        h1, h2 { margin-top: 0; border-bottom: 2px solid #30363D; padding-bottom: 10px; }
        .filters { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; }
        .filter-item { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-size: 0.9em; color: #8B949E; }
        input[type="date"] { background-color: #010409; color: #FAFAFA; border: 1px solid #30363D; border-radius: 6px; padding: 8px; }
        
        /* --- ESTILOS PARA O NOVO FILTRO BOOTSTRAP MULTISELECT --- */
        .filter-item-unidades { min-width: 300px; max-width: 500px; }
        .btn-group { width: 100%; }
        .multiselect {
            width: 100% !important;
            background-color: #010409 !important;
            border: 1px solid #30363D !important;
            color: #FAFAFA !important;
            text-align: left;
        }
        .multiselect-container {
            background-color: #161B22;
            border: 1px solid #30363D;
            box-shadow: none;
        }
        .multiselect-container > li > a > label {
            color: #FAFAFA;
            padding: 8px 10px;
        }
        .multiselect-container > li:not(.multiselect-group):not(.multiselect-filter):hover {
             background-color: #58A6FF;
        }
        .multiselect-container .multiselect-filter .form-control {
            background-color: #010409;
            color: #FAFAFA;
            border: 1px solid #30363D;
        }
        .multiselect-container > li > a > label.checkbox input[type="checkbox"] {
            margin-right: 10px;
        }
        /* --- FIM DOS ESTILOS NOVOS --- */

        .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .kpi-card { text-align: center; }
        .kpi-value { font-size: 2.5em; font-weight: bold; color: #58A6FF; }
        .kpi-label { font-size: 1em; color: #8B949E; }
        .loader { text-align: center; font-size: 1.5em; padding: 50px; }
        .dataTables_wrapper { color: #FAFAFA; }
        .dataTables_wrapper .dataTables_length select, .dataTables_wrapper .dataTables_filter input { background-color: #010409; color: #FAFAFA; border: 1px solid #30363D; border-radius: 6px; padding: 5px; }
        .dataTables_wrapper .dataTables_paginate .paginate_button { color: #FAFAFA !important; border: 1px solid #30363D; }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current { background: #58A6FF !important; border-color: #58A6FF !important; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header"><h1>Dashboard de Vendas e Metas</h1></header>
        <section id="loader" class="filters"><div class="loader">Carregando dados da API e Planilha...</div></section>
        
        <section class="filters" id="filters-section" style="display: none;">
            <div class="filter-item filter-item-unidades">
                <label for="unidade-filter">Filtrar por Unidade(s)</label>
                <select id="unidade-filter" multiple="multiple"></select>
            </div>
            <div class="filter-item">
                <label for="start-date">Data de Início</label>
                <input type="date" id="start-date">
            </div>
            <div class="filter-item">
                <label for="end-date">Data de Fim</label>
                <input type="date" id="end-date">
            </div>
        </section>

        <section class="kpi-container" id="kpi-section" style="display: none;">
            <div class="kpi-card"><div class="kpi-value" id="kpi-vvr-total">R$ 0,00</div><div class="kpi-label">VVR Total Realizado</div></div>
            <div class="kpi-card"><div class="kpi-value" id="kpi-meta-vvr-total">R$ 0,00</div><div class="kpi-label">Meta VVR Total</div></div>
            <div class="kpi-card"><div class="kpi-value" id="kpi-atingimento-vvr">0%</div><div class="kpi-label">Atingimento VVR</div></div>
            <div class="kpi-card"><div class="kpi-value" id="kpi-adesoes">0</div><div class="kpi-label">Adesões Realizadas</div></div>
        </section>
        <section class="chart-container" id="chart-vvr-mes-section" style="display: none;">
            <h2>VVR Realizado vs. Meta por Mês (Ano Vigente)</h2>
            <canvas id="vvrVsMetaPorMesChart"></canvas>
        </section>
        <section class="table-container" id="table-section" style="display: none;">
            <h2>Dados Detalhados por Mês/Unidade (Período Selecionado)</h2>
            <table id="dados-table" class="display" style="width:100%">
                <thead> <tr> <th>Unidade</th><th>Período</th><th>VVR Realizado</th><th>Meta VVR</th><th>Atingimento VVR</th><th>Adesões Realizadas</th><th>Meta Adesões</th><th>Atingimento Adesões</th> </tr> </thead>
                <tbody></tbody>
            </table>
        </section>
    </div>

<script>
    // --- Configurações ---
    const API_URL = "https://api-adesoes-comercial.vercel.app/dados";
    const SPREADSHEET_ID = "1KywSOsTn7qUdVp2dLthWD3Y27RsE1aInk6hRJhp7BFw";
    const SHEET_NAME = "metas";
    const API_KEY = "AIzaSyBuGRH91CnRuDtN5RGsb5DvHEfhTxJnWSs"; // Lembrete de segurança: Mover para o backend
    const GOOGLE_SHEETS_API_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;

    // --- Variáveis Globais ---
    let allData = [], metasData = new Map(), dataTable, vvrVsMetaPorMesChart;
    
    // --- Funções de Formatação ---
    const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
    const formatPercent = (value) => new Intl.NumberFormat('pt-BR', { style: 'percent', minimumFractionDigits: 1 }).format(value || 0);

    // --- Inicialização do Dashboard ---
    document.addEventListener('DOMContentLoaded', async () => {
        const loader = document.getElementById('loader');
        try {
            const [apiData, sheetData] = await Promise.all([fetchAllApiData(), fetchMetasData()]);
            allData = apiData;
            metasData = sheetData;

            if (allData && allData.length > 0) {
                loader.style.display = 'none';
                ['filters-section', 'kpi-section', 'chart-vvr-mes-section', 'table-section'].forEach(id => document.getElementById(id).style.display = 'block');
                document.getElementById('filters-section').style.display = 'flex';
                document.getElementById('kpi-section').style.display = 'grid';
                
                populateFilters();
                addEventListeners();
                updateDashboard();
            } else { loader.innerHTML = 'Nenhum dado encontrado na API.'; }
        } catch (error) { console.error("Erro fatal na inicialização:", error); loader.innerHTML = `Erro ao carregar dados. Verifique o console.`; }
    });

    // --- Funções de Busca de Dados (sem alteração) ---
    async function fetchAllApiData() { let fetchedData = []; let offset = 0; const limit = 5000; while (true) { try { const response = await fetch(`${API_URL}?limit=${limit}&offset=${offset}`); if (!response.ok) { console.error('API Error:', response.statusText); break; } const dataObject = await response.json(); const pageData = dataObject.dados || []; if (pageData.length === 0) { break; } fetchedData.push(...pageData); offset += limit; } catch (error) { console.error('Fetch Error:', error); break; } } return fetchedData.map(d => { if (!d.dt_cadastro_integrante) return null; return { ...d, vl_plano: parseFloat(d.vl_plano) || 0, dt_cadastro_integrante: new Date(d.dt_cadastro_integrante) } }).filter(Boolean); }
    async function fetchMetasData() { if (!API_KEY || !SPREADSHEET_ID || !SHEET_NAME) { console.error("Configurações da planilha incompletas."); return new Map(); } try { const response = await fetch(GOOGLE_SHEETS_API_URL); if (!response.ok) { const errorData = await response.json(); console.error("Erro API Google Sheets:", errorData); return new Map(); } const data = await response.json(); const rows = data.values || []; const metasMap = new Map(); const headers = rows[0].map(h => h.trim()); const unidadeIndex = headers.indexOf("nm_unidade"), anoIndex = headers.indexOf("ANO"), mesIndex = headers.indexOf("MÊS"), metaVvrIndex = headers.indexOf("meta vl_plano"), metaAdesoesIndex = headers.indexOf("META ADESÕES"); rows.slice(1).forEach(row => { if (row.length < headers.length) return; const unidade = row[unidadeIndex], ano = row[anoIndex], mes = String(row[mesIndex]).padStart(2, '0'), metaVvrString = String(row[metaVvrIndex] || "0"), metaVvr = parseFloat(metaVvrString.replace(/\./g, '').replace(',', '.')) || 0, metaAdesoes = parseInt(row[metaAdesoesIndex]) || 0; if (unidade && ano && mes) { const chave = `${unidade}-${ano}-${mes}`; metasMap.set(chave, { meta_vvr: metaVvr, meta_adesoes: metaAdesoes }); } }); return metasMap; } catch (error) { console.error("Erro CRÍTICO ao buscar metas:", error); return new Map(); } }

    // --- Funções do Dashboard ---
    
    // ATUALIZADO: Usando Bootstrap Multiselect
    function populateFilters() {
        const unidades = [...new Set(allData.map(d => d.nm_unidade))].sort();
        const unidadeFilter = $('#unidade-filter'); // Usando seletor jQuery
        unidadeFilter.empty();

        unidades.forEach(u => {
            unidadeFilter.append($('<option>', { value: u, text: u }));
        });

        // Inicializa o Bootstrap Multiselect
        unidadeFilter.multiselect({
            enableFiltering: true,
            includeSelectAllOption: true,
            selectAllText: 'Marcar todos',
            filterPlaceholder: 'Pesquisar unidades...',
            nonSelectedText: 'Todas as unidades',
            nSelectedText: 'unidades selecionadas',
            allSelectedText: 'Todas as unidades selecionadas',
            buttonWidth: '100%',
            maxHeight: 300,
            onChange: function(option, checked) {
                updateDashboard(); // Dispara a atualização a cada mudança
            }
        });

        const hoje = new Date();
        const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
        document.getElementById('start-date').value = inicioMes.toISOString().split('T')[0];
        document.getElementById('end-date').value = fimMes.toISOString().split('T')[0];
    }
    
    // ATUALIZADO: Listeners simplificados
    function addEventListeners() {
        // O listener do filtro de unidade agora é configurado dentro do próprio plugin .multiselect()
        document.getElementById('start-date').addEventListener('change', updateDashboard);
        document.getElementById('end-date').addEventListener('change', updateDashboard);
    }
    
    function processAndCrossReferenceData(salesData) {
        const vendasPorMesUnidade = salesData.reduce((acc, d) => {
            const periodo = d.dt_cadastro_integrante.toISOString().slice(0, 7);
            const chave = `${d.nm_unidade}-${periodo}`;
            if (!acc[chave]) { acc[chave] = { unidade: d.nm_unidade, periodo: periodo, realizado_vvr: 0, realizado_adesoes: 0 }; }
            acc[chave].realizado_vvr += d.vl_plano;
            acc[chave].realizado_adesoes += 1;
            return acc;
        }, {});
        return Object.values(vendasPorMesUnidade).map(item => {
            const chaveMeta = `${item.unidade}-${item.periodo}`;
            const meta = metasData.get(chaveMeta) || { meta_vvr: 0, meta_adesoes: 0 };
            const atingimentoVvr = meta.meta_vvr > 0 ? item.realizado_vvr / meta.meta_vvr : 0;
            const atingimentoAdesoes = meta.meta_adesoes > 0 ? item.realizado_adesoes / meta.meta_adesoes : 0;
            return { ...item, ...meta, atingimento_vvr: atingimentoVvr, atingimento_adesoes: atingimentoAdesoes };
        });
    }

    // ATUALIZADO: Lendo valores do Bootstrap Multiselect
    function updateDashboard() {
        // O .val() do jQuery em um multiselect retorna um array dos selecionados, ou null se nenhum for selecionado.
        const selectedUnidades = $('#unidade-filter').val() || [];

        // --- 1. LÓGICA PARA O GRÁFICO (ANO VIGENTE: 2025) ---
        const anoVigente = 2025;
        const dataParaGrafico = allData.filter(d => {
            const isUnidadeMatch = selectedUnidades.length === 0 ? true : selectedUnidades.includes(d.nm_unidade);
            const isAnoMatch = d.dt_cadastro_integrante.getFullYear() === anoVigente;
            return isUnidadeMatch && isAnoMatch;
        });
        const finalDataGrafico = processAndCrossReferenceData(dataParaGrafico);
        updateVvrVsMetaPorMesChart(finalDataGrafico);

        // --- 2. LÓGICA PARA KPIs E TABELA (USA O FILTRO DE DATA) ---
        const startDate = new Date(document.getElementById('start-date').value + 'T00:00:00');
        const endDate = new Date(document.getElementById('end-date').value + 'T23:59:59');

        const dataParaKpiTabela = allData.filter(d => {
            const isUnidadeMatch = selectedUnidades.length === 0 ? true : selectedUnidades.includes(d.nm_unidade);
            const isDateMatch = d.dt_cadastro_integrante >= startDate && d.dt_cadastro_integrante <= endDate;
            return isUnidadeMatch && isDateMatch;
        });
        const finalDataKpiTabela = processAndCrossReferenceData(dataParaKpiTabela);
        updateKPIs(finalDataKpiTabela, dataParaKpiTabela);
        updateDataTable(finalDataKpiTabela);
    }

    // --- Funções de Atualização Visual (sem alteração) ---
    function updateKPIs(dataAgregada, dataBruta) { const vvrTotal = dataAgregada.reduce((sum, d) => sum + d.realizado_vvr, 0); const metaVvrTotal = dataAgregada.reduce((sum, d) => sum + d.meta_vvr, 0); const atingimentoVvrTotal = metaVvrTotal > 0 ? vvrTotal / metaVvrTotal : 0; const adesoesTotal = dataBruta.length; document.getElementById('kpi-vvr-total').textContent = formatCurrency(vvrTotal); document.getElementById('kpi-meta-vvr-total').textContent = formatCurrency(metaVvrTotal); document.getElementById('kpi-atingimento-vvr').textContent = formatPercent(atingimentoVvrTotal); document.getElementById('kpi-adesoes').textContent = adesoesTotal.toLocaleString('pt-BR'); }
    function updateVvrVsMetaPorMesChart(data) { const dataPorPeriodo = data.reduce((acc, d) => { if (!acc[d.periodo]) acc[d.periodo] = { realizado: 0, meta: 0 }; acc[d.periodo].realizado += d.realizado_vvr; acc[d.periodo].meta += d.meta_vvr; return acc; }, {}); const labels = Object.keys(dataPorPeriodo).sort(); const realizadoValues = labels.map(p => dataPorPeriodo[p].realizado); const metaValues = labels.map(p => dataPorPeriodo[p].meta); if (vvrVsMetaPorMesChart) vvrVsMetaPorMesChart.destroy(); Chart.register(ChartDataLabels); vvrVsMetaPorMesChart = new Chart(document.getElementById('vvrVsMetaPorMesChart'), { type: 'bar', data: { labels: labels, datasets: [ { label: 'VVR Realizado', data: realizadoValues, backgroundColor: 'rgba(88, 166, 255, 0.7)', order: 1 }, { label: 'Meta VVR', data: metaValues, type: 'line', borderColor: 'rgb(255, 99, 132)', order: 0, datalabels: { display: false } } ] }, options: { plugins: { datalabels: { anchor: 'end', align: 'end', formatter: (value) => (value >= 1000 ? `${(value / 1000).toFixed(0)}k` : value.toFixed(0)), color: '#FAFAFA', font: { weight: 'bold' } } }, scales: { y: { beginAtZero: true } } } }); }
    function updateDataTable(data) { const tableData = data.sort((a,b) => a.periodo.localeCompare(b.periodo) || a.unidade.localeCompare(b.unidade)).map(d => [d.unidade, d.periodo, formatCurrency(d.realizado_vvr), formatCurrency(d.meta_vvr), formatPercent(d.atingimento_vvr), d.realizado_adesoes, d.meta_adesoes, formatPercent(d.atingimento_adesoes)]); if (dataTable) { dataTable.clear().rows.add(tableData).draw(); } else { dataTable = $('#dados-table').DataTable({ data: tableData, pageLength: 10, language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json' }, destroy: true }); } }
</script>
</body>
</html>
