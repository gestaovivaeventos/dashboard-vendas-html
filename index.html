<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Vendas</title>
    <!-- Bibliotecas de Gráficos e Tabelas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.js"></script>
    
    <!-- Bibliotecas: Bootstrap e Bootstrap Multiselect -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/1.1.2/css/bootstrap-multiselect.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/1.1.2/js/bootstrap-multiselect.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #212529; color: #F8F9FA; margin: 0; padding: 0; }
        .container { display: grid; grid-template-columns: repeat(12, 1fr); grid-gap: 20px; padding: 20px; width: 100%; box-sizing: border-box; }
        .header, .filters, .kpi-container, .chart-container, .table-container { 
            grid-column: span 12; 
            background-color: #343A40; 
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid #495057; 
        }

        /* --- ALTERAÇÃO CSS PARA O LOGO --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #company-logo {
            height: 45px; /* Ajuste a altura do seu logo conforme necessário */
            width: auto;
        }
        /* --- FIM DA ALTERAÇÃO --- */

        h1, h2 { margin-top: 0; border-bottom: 2px solid #495057; padding-bottom: 10px; }
        .filters { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; }
        .filter-item { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-size: 0.9em; color: #ADB5BD; }
        input[type="date"] { background-color: #212529; color: #F8F9FA; border: 1px solid #495057; border-radius: 6px; padding: 8px; }
        
        .filter-item-unidades { min-width: 300px; max-width: 500px; }
        .btn-group { width: 100%; }
        .multiselect { width: 100% !important; background-color: #212529 !important; border: 1px solid #495057 !important; color: #F8F9FA !important; text-align: left; }
        .multiselect-container { background-color: #343A40; border: 1px solid #495057; box-shadow: none; }
        .multiselect-container > li > a > label { color: #F8F9FA; padding: 8px 10px; }
        .multiselect-container > li:not(.multiselect-group):not(.multiselect-filter):hover { background-color: #FFC107; color: #212529; }
        .multiselect-container .multiselect-filter .form-control { background-color: #212529; color: #F8F9FA; border: 1px solid #495057; }
        .multiselect-container > li > a > label.checkbox input[type="checkbox"] { margin-right: 10px; }
        
        .kpi-main-wrapper { display: flex; flex-wrap: wrap; align-items: center; gap: 20px; }
        .kpi-main-cards-container { display: flex; flex-grow: 1; flex-wrap: wrap; gap: 20px; }
        .kpi-main-card { flex: 1; min-width: 220px; display: flex; flex-direction: column; gap: 8px; border-left: 1px solid #495057; padding-left: 20px; }
        .kpi-main-card:first-child { border-left: none; padding-left: 0; }
        .kpi-card-title { font-size: 0.9em; color: #ADB5BD; font-weight: bold; }
        .kpi-card-value { font-size: 2.1em; font-weight: bold; color: #F8F9FA; }
        .kpi-card-details { font-size: 0.8em; color: #ADB5BD; }
        .kpi-card-details .percent { font-weight: bold; transition: color 0.5s ease-in-out; }
        .progress-bar-bg { width: 100%; height: 10px; background-color: #495057; border-radius: 5px; overflow: hidden; }
        .progress-bar-fg { height: 100%; border-radius: 5px; width: 0%; transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out; }
        
        .loader { text-align: center; font-size: 1.5em; padding: 50px; }
        .dataTables_wrapper { color: #F8F9FA; }
        .dataTables_wrapper .dataTables_length select, .dataTables_wrapper .dataTables_filter input { background-color: #212529; color: #F8F9FA; border: 1px solid #495057; border-radius: 6px; padding: 5px; }
        .dataTables_wrapper .dataTables_paginate .paginate_button { color: #F8F9FA !important; border: 1px solid #495057; }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current { background: #FFC107 !important; border-color: #FFC107 !important; color: #212529 !important; }
    </style>
</head>
<body>
    <div class="container">
       <!-- --- BLOCO HEADER COM A URL COMPLETA E CORRETA --- -->
        <header class="header">
            <h1>Dashboard de Vendas e Metas</h1>
            <!-- A URL DEVE ser a completa, começando com https:// -->
            <img id="company-logo" 
                 src="https://raw.githubusercontent.com/gestaovivaeventos/dashboard-vendas-html/main/logoviva.png" 
                 alt="Logo da Empresa">
        </header>
        <!-- --- FIM DA CORREÇÃO --- -->

        <section id="loader" class="filters"><div class="loader">Carregando dados...</div></section>
        
        <section class="filters" id="filters-section" style="display: none;">
            <div class="filter-item filter-item-unidades"><label for="unidade-filter">Filtrar por Unidade(s)</label><select id="unidade-filter" multiple="multiple"></select></div>
            <div class="filter-item"><label for="start-date">Data de Início</label><input type="date" id="start-date"></div>
            <div class="filter-item"><label for="end-date">Data de Fim</label><input type="date" id="end-date"></div>
        </section>

        <section class="kpi-container" id="kpi-section" style="display: none;">
            <div class="kpi-main-wrapper">
                <div class="kpi-main-cards-container">
                    <div class="kpi-main-card">
                        <span class="kpi-card-title">REALIZADO TOTAL</span>
                        <span class="kpi-card-value" id="kpi-total-realizado">R$ 0,00</span>
                        <span class="kpi-card-details"><span class="percent" id="kpi-total-percent">0,0%</span> de <span id="kpi-total-meta">R$ 0,00</span> META TOTAL</span>
                        <div class="progress-bar-bg"><div class="progress-bar-fg" id="kpi-total-progress"></div></div>
                    </div>
                    <div class="kpi-main-card">
                        <span class="kpi-card-title">REALIZADO VENDAS</span>
                        <span class="kpi-card-value" id="kpi-vendas-realizado">R$ 0,00</span>
                        <span class="kpi-card-details"><span class="percent" id="kpi-vendas-percent">0,0%</span> de <span id="kpi-vendas-meta">R$ 0,00</span> META VENDAS</span>
                        <div class="progress-bar-bg"><div class="progress-bar-fg" id="kpi-vendas-progress"></div></div>
                    </div>
                    <div class="kpi-main-card">
                        <span class="kpi-card-title">REALIZADO PÓS VENDAS</span>
                        <span class="kpi-card-value" id="kpi-posvendas-realizado">R$ 0,00</span>
                        <span class="kpi-card-details"><span class="percent" id="kpi-posvendas-percent">0,0%</span> de <span id="kpi-posvendas-meta">R$ 0,00</span> META PÓS VENDAS</span>
                        <div class="progress-bar-bg"><div class="progress-bar-fg" id="kpi-posvendas-progress"></div></div>
                    </div>
                </div>
            </div>
        </section>

        <section class="chart-container" id="chart-vvr-mes-section" style="display: none;"><h2>VVR Realizado vs. Meta por Mês (Ano Vigente)</h2><canvas id="vvrVsMetaPorMesChart"></canvas></section>
        <section class="table-container" id="table-section" style="display: none;"><h2>Dados Detalhados por Mês/Unidade (Período Selecionado)</h2><table id="dados-table" class="display" style="width:100%"><thead><tr><th>Unidade</th><th>Período</th><th>VVR Realizado</th><th>Meta VVR</th><th>Atingimento VVR</th><th>Adesões Realizadas</th><th>Meta Adesões</th><th>Atingimento Adesões</th></tr></thead><tbody></tbody></table></section>
    </div>

<script>
    // --- O JAVASCRIPT ABAIXO PERMANECE O MESMO ---
    const API_URL = "https://api-adesoes-comercial.vercel.app/dados";
    const SPREADSHEET_ID = "1KywSOsTn7qUdVp2dLthWD3Y27RsE1aInk6hRJhp7BFw";
    const SHEET_NAME = "metas";
    const API_KEY = "AIzaSyBuGRH91CnRuDtN5RGsb5DvHEfhTxJnWSs"; 
    const GOOGLE_SHEETS_API_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;

    let allData = [], metasData = new Map(), dataTable, vvrVsMetaPorMesChart;
    
    const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
    const formatPercent = (value) => new Intl.NumberFormat('pt-BR', { style: 'percent', minimumFractionDigits: 1 }).format(value || 0);

    document.addEventListener('DOMContentLoaded', async () => {
        const loader = document.getElementById('loader');
        try {
            const [apiData, sheetData] = await Promise.all([fetchAllApiData(), fetchMetasData()]);
            allData = apiData;
            metasData = sheetData;

            if (allData && allData.length > 0) {
                loader.style.display = 'none';
                ['filters-section', 'kpi-section', 'chart-vvr-mes-section', 'table-section'].forEach(id => document.getElementById(id).style.display = 'block');
                document.getElementById('filters-section').style.display = 'flex';
                
                populateFilters();
                addEventListeners();
                updateDashboard();
            } else { loader.innerHTML = 'Nenhum dado encontrado na API.'; }
        } catch (error) { console.error("Erro fatal na inicialização:", error); loader.innerHTML = `Erro ao carregar dados. Verifique o console.`; }
    });

    async function fetchAllApiData() { 
        let fetchedData = []; let offset = 0; const limit = 5000; 
        while (true) { 
            try { 
                const response = await fetch(`${API_URL}?limit=${limit}&offset=${offset}`); 
                if (!response.ok) { console.error('API Error:', response.statusText); break; } 
                const dataObject = await response.json(); 
                const pageData = dataObject.dados || []; 
                if (pageData.length === 0) break; 
                fetchedData.push(...pageData); 
                offset += limit; 
            } catch (error) { console.error('Fetch Error:', error); break; } 
        } 
        return fetchedData.map(d => { 
            if (!d.dt_cadastro_integrante) return null; 
            return { ...d, vl_plano: parseFloat(d.vl_plano) || 0, dt_cadastro_integrante: new Date(d.dt_cadastro_integrante), venda_posvenda: d.venda_posvenda || 'VENDA' } 
        }).filter(Boolean); 
    }

    async function fetchMetasData() {
        if (!API_KEY || !SPREADSHEET_ID || !SHEET_NAME) { console.error("Configurações da planilha incompletas."); return new Map(); }
        try {
            const response = await fetch(GOOGLE_SHEETS_API_URL);
            if (!response.ok) { console.error("Erro API Google Sheets:", await response.json()); return new Map(); }
            const data = await response.json();
            const rows = data.values || [];
            const metasMap = new Map();
            const headers = rows[0].map(h => h.trim().toLowerCase());
            
            const unidadeIndex = headers.indexOf("nm_unidade");
            const anoIndex = headers.indexOf("ano");
            const mesIndex = headers.indexOf("mês");
            const metaVendasIndex = headers.indexOf("meta vvr_venda");
            const metaPosvendasIndex = headers.indexOf("meta vvr_pos_venda");
            const metaAdesoesIndex = headers.indexOf("meta adesões");

            rows.slice(1).forEach(row => {
                const unidade = row[unidadeIndex];
                const ano = row[anoIndex];
                const mes = String(row[mesIndex]).padStart(2, '0');
                
                const parseMetaValue = (index) => parseFloat(String(row[index] || "0").replace(/\./g, '').replace(',', '.')) || 0;

                const metaVendas = parseMetaValue(metaVendasIndex);
                const metaPosvendas = parseMetaValue(metaPosvendasIndex);
                const metaAdesoes = parseInt(row[metaAdesoesIndex]) || 0;

                if (unidade && ano && mes) {
                    const chave = `${unidade}-${ano}-${mes}`;
                    metasMap.set(chave, {
                        meta_vvr_vendas: metaVendas,
                        meta_vvr_posvendas: metaPosvendas,
                        meta_vvr_total: metaVendas + metaPosvendas,
                        meta_adesoes: metaAdesoes
                    });
                }
            });
            return metasMap;
        } catch (error) { console.error("Erro CRÍTICO ao buscar metas:", error); return new Map(); }
    }
    
    function processAndCrossReferenceData(salesData) {
        const vendasPorMesUnidade = salesData.reduce((acc, d) => {
            const periodo = d.dt_cadastro_integrante.toISOString().slice(0, 7);
            const chave = `${d.nm_unidade}-${periodo}`;
            if (!acc[chave]) { acc[chave] = { unidade: d.nm_unidade, periodo: periodo, realizado_vvr: 0, realizado_adesoes: 0 }; }
            acc[chave].realizado_vvr += d.vl_plano;
            acc[chave].realizado_adesoes += 1;
            return acc;
        }, {});
        return Object.values(vendasPorMesUnidade).map(item => {
            const chaveMeta = `${item.unidade}-${item.periodo}`;
            const meta = metasData.get(chaveMeta) || { meta_vvr_total: 0, meta_vvr_vendas: 0, meta_vvr_posvendas: 0, meta_adesoes: 0 };
            return { ...item, ...meta };
        });
    }

    function updateMainKPIs(dataBruta, dataAgregadaComMetas) {
        const getColorForPercentage = (percent) => {
            if (percent >= 1) return '#28a745';
            if (percent >= 0.5) return '#ffc107';
            return '#dc3545';
        };

        const normalizeText = (text) => text?.trim().toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const realizadoVendas = dataBruta.filter(d => normalizeText(d.venda_posvenda) === 'VENDA').reduce((sum, d) => sum + d.vl_plano, 0);
        const realizadoPosVendas = dataBruta.filter(d => normalizeText(d.venda_posvenda) === 'POS VENDA').reduce((sum, d) => sum + d.vl_plano, 0);
        const realizadoTotal = realizadoVendas + realizadoPosVendas;
        const metaVendas = dataAgregadaComMetas.reduce((sum, d) => sum + d.meta_vvr_vendas, 0);
        const metaPosVendas = dataAgregadaComMetas.reduce((sum, d) => sum + d.meta_vvr_posvendas, 0);
        const metaTotal = metaVendas + metaPosVendas;
        const percentTotal = metaTotal > 0 ? realizadoTotal / metaTotal : 0;
        const percentVendas = metaVendas > 0 ? realizadoVendas / metaVendas : 0;
        const percentPosVendas = metaPosVendas > 0 ? realizadoPosVendas / metaPosVendas : 0;
        
        const totalColor = getColorForPercentage(percentTotal);
        document.getElementById('kpi-total-realizado').textContent = formatCurrency(realizadoTotal);
        document.getElementById('kpi-total-meta').textContent = formatCurrency(metaTotal);
        const totalPercentEl = document.getElementById('kpi-total-percent');
        totalPercentEl.textContent = formatPercent(percentTotal);
        totalPercentEl.style.color = totalColor;
        document.getElementById('kpi-total-progress').style.backgroundColor = totalColor;
        document.getElementById('kpi-total-progress').style.width = `${Math.min(percentTotal * 100, 100)}%`;

        const vendasColor = getColorForPercentage(percentVendas);
        document.getElementById('kpi-vendas-realizado').textContent = formatCurrency(realizadoVendas);
        document.getElementById('kpi-vendas-meta').textContent = formatCurrency(metaVendas);
        const vendasPercentEl = document.getElementById('kpi-vendas-percent');
        vendasPercentEl.textContent = formatPercent(percentVendas);
        vendasPercentEl.style.color = vendasColor;
        document.getElementById('kpi-vendas-progress').style.backgroundColor = vendasColor;
        document.getElementById('kpi-vendas-progress').style.width = `${Math.min(percentVendas * 100, 100)}%`;
        
        const posVendasColor = getColorForPercentage(percentPosVendas);
        document.getElementById('kpi-posvendas-realizado').textContent = formatCurrency(realizadoPosVendas);
        document.getElementById('kpi-posvendas-meta').textContent = formatCurrency(metaPosVendas);
        const posVendasPercentEl = document.getElementById('kpi-posvendas-percent');
        posVendasPercentEl.textContent = formatPercent(percentPosVendas);
        posVendasPercentEl.style.color = posVendasColor;
        document.getElementById('kpi-posvendas-progress').style.backgroundColor = posVendasColor;
        document.getElementById('kpi-posvendas-progress').style.width = `${Math.min(percentPosVendas * 100, 100)}%`;
    }

    function updateDashboard() {
        const selectedUnidades = $('#unidade-filter').val() || [];
        const anoVigente = 2025;
        const dataParaGrafico = allData.filter(d => (selectedUnidades.length === 0 || selectedUnidades.includes(d.nm_unidade)) && d.dt_cadastro_integrante.getFullYear() === anoVigente);
        updateVvrVsMetaPorMesChart(dataParaGrafico, anoVigente);

        const startDate = new Date(document.getElementById('start-date').value + 'T00:00:00');
        const endDate = new Date(document.getElementById('end-date').value + 'T23:59:59');
        const dataBrutaFiltrada = allData.filter(d => (selectedUnidades.length === 0 || selectedUnidades.includes(d.nm_unidade)) && d.dt_cadastro_integrante >= startDate && d.dt_cadastro_integrante <= endDate);
        const dataAgregadaFiltrada = processAndCrossReferenceData(dataBrutaFiltrada);
        
        updateMainKPIs(dataBrutaFiltrada, dataAgregadaFiltrada);
        updateDataTable(dataAgregadaFiltrada);
    }
    
    function updateVvrVsMetaPorMesChart(salesDataForYear, anoVigente) {
        const allYearPeriodos = Array.from({ length: 12 }, (_, i) => `${anoVigente}-${String(i + 1).padStart(2, '0')}`);
        const chartDataMap = new Map();
        allYearPeriodos.forEach(periodo => {
            chartDataMap.set(periodo, { realizado: 0, meta: 0 });
        });

        salesDataForYear.forEach(d => {
            const periodo = d.dt_cadastro_integrante.toISOString().slice(0, 7);
            if (chartDataMap.has(periodo)) {
                chartDataMap.get(periodo).realizado += d.vl_plano;
            }
        });

        const selectedUnidades = $('#unidade-filter').val() || [...new Set(allData.map(d => d.nm_unidade))];
        metasData.forEach((metaInfo, key) => {
            const [unidade, ano, mes] = key.split('-');
            const periodo = `${ano}-${mes}`;
            if (ano == anoVigente && chartDataMap.has(periodo)) {
                if (selectedUnidades.length === 0 || selectedUnidades.includes(unidade)) {
                    chartDataMap.get(periodo).meta += metaInfo.meta_vvr_total;
                }
            }
        });

        const realizadoValues = allYearPeriodos.map(p => chartDataMap.get(p).realizado);
        const metaValues = allYearPeriodos.map(p => chartDataMap.get(p).meta);

        const formattedLabels = allYearPeriodos.map(periodo => {
            const [year, month] = periodo.split('-');
            const date = new Date(year, month - 1);
            const monthName = date.toLocaleString('pt-BR', { month: 'short' }).replace('.', '');
            const shortYear = year.slice(2);
            return `${monthName}-${shortYear}`;
        });
        
        if (vvrVsMetaPorMesChart) vvrVsMetaPorMesChart.destroy();
        Chart.register(ChartDataLabels);

        vvrVsMetaPorMesChart = new Chart(document.getElementById('vvrVsMetaPorMesChart'), {
            type: 'bar',
            data: {
                labels: formattedLabels,
                datasets: [
                    {
                        label: 'VVR Realizado',
                        data: realizadoValues,
                        backgroundColor: 'rgba(255, 193, 7, 0.7)',
                        order: 1
                    },
                    {
                        label: 'Meta VVR',
                        data: metaValues,
                        type: 'line',
                        borderColor: 'rgb(220, 53, 69)',
                        order: 0,
                        datalabels: {
                            display: true,
                            align: 'bottom',
                            backgroundColor: 'rgba(0, 0, 0, 0.6)',
                            borderRadius: 4,
                            color: 'white',
                            font: { size: 9 },
                            padding: 4,
                            formatter: (value) => (value > 0 ? `${(value / 1000).toFixed(0)}k` : '')
                        }
                    }
                ]
            },
            options: {
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        formatter: (value) => (value >= 1000 ? `${(value / 1000).toFixed(0)}k` : ''),
                        color: '#F8F9FA',
                        font: { weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) { label += formatCurrency(context.parsed.y); }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function updateDataTable(data) { const tableData = data.sort((a,b) => a.periodo.localeCompare(b.periodo) || a.unidade.localeCompare(b.unidade)).map(d => { const atingimentoVvr = d.meta_vvr_total > 0 ? d.realizado_vvr / d.meta_vvr_total : 0; const atingimentoAdesoes = d.meta_adesoes > 0 ? d.realizado_adesoes / d.meta_adesoes : 0; return [d.unidade, d.periodo, formatCurrency(d.realizado_vvr), formatCurrency(d.meta_vvr_total), formatPercent(atingimentoVvr), d.realizado_adesoes, d.meta_adesoes, formatPercent(atingimentoAdesoes)] }); if (dataTable) { dataTable.clear().rows.add(tableData).draw(); } else { dataTable = $('#dados-table').DataTable({ data: tableData, pageLength: 10, language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json' }, destroy: true }); } }
    function populateFilters() { const unidades = [...new Set(allData.map(d => d.nm_unidade))].sort(); const unidadeFilter = $('#unidade-filter'); unidadeFilter.empty(); unidades.forEach(u => { unidadeFilter.append($('<option>', { value: u, text: u })); }); unidadeFilter.multiselect({ enableFiltering: true, includeSelectAllOption: true, selectAllText: 'Marcar todos', filterPlaceholder: 'Pesquisar...', nonSelectedText: 'Todas as unidades', nSelectedText: 'unidades', allSelectedText: 'Todas selecionadas', buttonWidth: '100%', maxHeight: 300, onChange: function(option, checked) { updateDashboard(); } }); const hoje = new Date(); const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1); const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0); document.getElementById('start-date').value = inicioMes.toISOString().split('T')[0]; document.getElementById('end-date').value = fimMes.toISOString().split('T')[0]; }
    function addEventListeners() { document.getElementById('start-date').addEventListener('change', updateDashboard); document.getElementById('end-date').addEventListener('change', updateDashboard); }
</script>
</body>
</html>
