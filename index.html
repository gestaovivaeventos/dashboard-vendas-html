<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Vendas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.css">
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #0E1117;
            color: #FAFAFA;
            margin: 0;
            padding: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-gap: 20px;
        }
        .header, .filters, .kpi-container, .chart-container, .table-container {
            grid-column: span 12;
            background-color: #161B22;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #30363D;
        }
        h1, h2 {
            margin-top: 0;
            border-bottom: 2px solid #30363D;
            padding-bottom: 10px;
        }
        .filters {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .filter-item {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #8B949E;
        }
        select, input[type="date"] {
            background-color: #010409;
            color: #FAFAFA;
            border: 1px solid #30363D;
            border-radius: 6px;
            padding: 8px;
        }
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .kpi-card {
            text-align: center;
        }
        .kpi-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #58A6FF;
        }
        .kpi-label {
            font-size: 1em;
            color: #8B949E;
        }
        .loader {
            text-align: center;
            font-size: 1.5em;
            padding: 50px;
        }
        /* Estilo para DataTables */
        .dataTables_wrapper { color: #FAFAFA; }
        .dataTables_wrapper .dataTables_length select,
        .dataTables_wrapper .dataTables_filter input {
            background-color: #010409; color: #FAFAFA; border: 1px solid #30363D;
            border-radius: 6px; padding: 5px;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button { color: #FAFAFA !important; border: 1px solid #30363D; }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current { background: #58A6FF !important; border-color: #58A6FF !important; }
    </style>
</head>
<body>

    <div class="container">
        <header class="header"><h1>Dashboard de Vendas</h1></header>
        <section id="loader" class="filters"><div class="loader">Carregando dados da API...</div></section>
        <section class="filters" id="filters-section" style="display: none;">
            <div class="filter-item"><label for="unidade-filter">Filtrar por Unidade</label><select id="unidade-filter"></select></div>
            <div class="filter-item"><label for="start-date">Data de Início</label><input type="date" id="start-date"></div>
            <div class="filter-item"><label for="end-date">Data de Fim</label><input type="date" id="end-date"></div>
        </section>
        <section class="kpi-container" id="kpi-section" style="display: none;">
            <div class="kpi-card"><div class="kpi-value" id="kpi-vvr-total">R$ 0,00</div><div class="kpi-label">VVR Total no Período</div></div>
            <div class="kpi-card"><div class="kpi-value" id="kpi-adesoes">0</div><div class="kpi-label">Adesões no Período</div></div>
            <div class="kpi-card"><div class="kpi-value" id="kpi-ticket-medio">R$ 0,00</div><div class="kpi-label">Ticket Médio</div></div>
        </section>
        <section class="chart-container" id="chart1-section" style="display: none;"><h2>VVR por Unidade</h2><canvas id="vvrPorUnidadeChart"></canvas></section>
        <section class="chart-container" id="chart2-section" style="display: none;"><h2>Evolução de VVR no Tempo</h2><canvas id="vvrPorMesChart"></canvas></section>
        <section class="table-container" id="table-section" style="display: none;">
            <h2>Dados Detalhados</h2>
            <table id="dados-table" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>Cód. Integrante</th>
                        <th>Nome Integrante</th>
                        <th>Unidade</th>
                        <th>Cód. Fundo</th>
                        <th>Nome Fundo</th>
                        <th>VVR (Plano)</th>
                        <th>Data de Cadastro</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </div>

    <script>
        const API_URL = "https://api-adesoes-comercial.vercel.app/dados"; // <<< VERIFIQUE SE ESTA É A URL CORRETA!
        
        let allData = [];
        let vvrPorUnidadeChart, vvrPorMesChart;
        let dataTable;

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);

        document.addEventListener('DOMContentLoaded', async () => {
            const loader = document.getElementById('loader');
            allData = await fetchAllData();

            if (allData.length > 0) {
                loader.style.display = 'none';
                ['filters-section', 'kpi-section', 'chart1-section', 'chart2-section', 'table-section'].forEach(id => {
                    const el = document.getElementById(id);
                    el.style.display = el.tagName === 'SECTION' ? 'grid' : 'block';
                });
                document.getElementById
