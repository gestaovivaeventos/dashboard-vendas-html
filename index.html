<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Vendas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/1.1.2/css/bootstrap-multiselect.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/1.1.2/js/bootstrap-multiselect.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #212529; color: #F8F9FA; margin: 0; padding: 0; }
        .dashboard-wrapper { display: flex; }
        #sidebar { width: 350px; height: 100vh; background-color: #343A40; padding: 20px; position: fixed; top: 0; left: 0; overflow-y: auto; transition: transform 0.3s ease-in-out; z-index: 1000; }
        #sidebar.collapsed { transform: translateX(-100%); }
        #main-content { flex-grow: 1; padding: 20px; margin-left: 350px; transition: margin-left 0.3s ease-in-out; }
        #main-content.full-width { margin-left: 0; }
        #sidebar-toggle { position: fixed; top: 20px; left: 360px; z-index: 1001; background-color: #FFC107; color: #212529; border: none; border-radius: 0 5px 5px 0; width: 30px; height: 40px; cursor: pointer; font-size: 20px; line-height: 40px; text-align: center; transition: left 0.3s ease-in-out; }
        #sidebar-toggle.collapsed { left: 10px; }

        .page-navigation { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #495057; padding-bottom: 20px; }
        .page-navigation button { background-color: #495057; color: #F8F9FA; border: 1px solid #ADB5BD; padding: 10px 20px; cursor: pointer; transition: all 0.2s ease-in-out; width: 100%; text-align: left; border-radius: 6px; }
        .page-navigation button:not(.active):hover { background-color: #6c757d; border-color: #dee2e6; }
        .page-navigation button.active { background-color: #FFC107; color: #212529; border-color: #FFC107; font-weight: bold; }

        .page-content { display: none; }
        .page-content.active { display: contents; }

        .container { 
            display: grid; 
            grid-template-columns: repeat(12, 1fr); 
            grid-gap: 20px; 
            width: 100%; 
            box-sizing: border-box; 
            max-width: 100%;
        }
        .header, .filters, .kpi-container, .chart-container, .table-container { 
            grid-column: span 12; 
            background-color: #343A40; 
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid #495057; 
            display: flex;
            flex-direction: column;
        }
        
        .header { display: flex; justify-content: space-between; align-items: center; flex-direction: row; }
        #company-logo { height: 100px; width: auto; }
        h1, h2 { margin-top: 0; border-bottom: 2px solid #495057; padding-bottom: 10px; }
        .filters { display: flex; flex-direction: column; gap: 20px; align-items: stretch; }
        
        .chart-wrapper {
            position: relative;
            height: 75vh; 
        }
        
        .kpi-main-wrapper { display: flex; flex-wrap: wrap; align-items: center; gap: 20px; }
        .kpi-main-cards-container { display: flex; flex-grow: 1; flex-wrap: wrap; gap: 20px; }
        .kpi-main-card { flex: 1; min-width: 220px; display: flex; flex-direction: column; gap: 8px; border-left: 1px solid #495057; padding-left: 20px; }
        .kpi-main-card:first-child { border-left: none; padding-left: 0; }
        .kpi-card-title { font-size: 0.9em; color: #ADB5BD; font-weight: bold; }
        .kpi-card-value { font-size: 2.1em; font-weight: bold; color: #F8F9FA; }
        .kpi-card-details { font-size: 0.8em; color: #ADB5BD; }
        .kpi-card-details .percent { font-weight: bold; transition: color 0.5s ease-in-out; }
        .progress-bar-bg { width: 100%; height: 10px; background-color: #495057; border-radius: 5px; overflow: hidden; }
        .progress-bar-fg { height: 100%; border-radius: 5px; width: 0%; transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out; }
        
        .loader { text-align: center; font-size: 1.5em; padding: 50px; }
        .dataTables_wrapper { color: #F8F9FA; }
        .dataTables_wrapper .dataTables_length select, .dataTables_wrapper .dataTables_filter input { background-color: #212529; color: #F8F9FA; border: 1px solid #495057; border-radius: 6px; padding: 5px; }
        .dataTables_wrapper .dataTables_paginate .paginate_button { color: #F8F9FA !important; border: 1px solid #495057; }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current { background: #FFC107 !important; border-color: #FFC107 !important; color: #212529 !important; }

        .dt-button { background-color: #495057 !important; color: #F8F9FA !important; border: 1px solid #ADB5BD !important; border-radius: 6px !important; padding: 5px 15px !important; margin-bottom: 15px !important; }
        .dt-button:hover { background-color: #ADB5BD !important; color: #212529 !important; }

        .chart-selector { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .chart-selector button { background-color: #495057; color: #F8F9FA; border: 1px solid #ADB5BD; border-radius: 6px; padding: 5px 15px; cursor: pointer; transition: all 0.2s ease-in-out; }
        .chart-selector button:not(.active):hover { background-color: #6c757d; border-color: #dee2e6; }
        .chart-selector button.active { background-color: #FFC107; color: #212529; border-color: #FFC107; font-weight: bold; }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            grid-column: span 12;
        }
        
        .chart-row > .chart-container {
            grid-column: auto;
        }
    </style>
</head>
<body>
    <div class="dashboard-wrapper">
        <button id="sidebar-toggle">&#9776;</button>

        <div id="sidebar">
            <div class="page-navigation">
                <button id="btn-page1" class="active" data-page="page1">Metas e Resultados</button>
                <button id="btn-page2" data-page="page2">Indicadores Secundários</button>
            </div>

            <section id="loader" class="filters"><div class="loader">Carregando dados...</div></section>
            <section class="filters" id="filters-section" style="display: none;">
                <div class="filter-item filter-item-unidades"><label for="unidade-filter">Filtrar por Unidade(s)</label><select id="unidade-filter" multiple="multiple"></select></div>
                <div class="filter-item"><label for="start-date">Data de Início</label><input type="date" id="start-date"></div>
                <div class="filter-item"><label for="end-date">Data de Fim</label><input type="date" id="end-date"></div>
            </section>
        </div>

        <div id="main-content">
            <div class="container">
                <header class="header">
                    <h1>Dashboard de Vendas e Metas</h1>
                    <img id="company-logo" src="Rockets2.png" alt="Logo da Empresa">
                </header>

                <div id="page1" class="page-content active">
                    </div>

                <div id="page2" class="page-content">
                    <section class="chart-container" id="chart-monthly-vvr-section" style="display: none;">
                        <h2>Comparativo de VVR Mensal</h2>
                        <div class="chart-selector" id="monthly-chart-selector"></div>
                        <div class="chart-wrapper">
                           <canvas id="monthlyVvrChart"></canvas>
                        </div>
                    </section>

                    <div class="chart-row">
                        <div class="chart-container" id="chart-yearly-stacked-section" style="display: none;">
                            <h2>Venda Realizada Total Anual</h2>
                            <div class="chart-wrapper">
                                <canvas id="yearlyStackedChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container" id="chart-monthly-stacked-section" style="display: none;">
                            <h2 id="monthly-stacked-title">Venda Realizada Total Mensal</h2>
                            <div class="chart-wrapper">
                                <canvas id="monthlyStackedChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-row">
                        <div class="chart-container" id="chart-yearly-ticket-section" style="display: none;">
                            <h2>Ticket Médio Anual</h2>
                            <div class="chart-wrapper">
                                <canvas id="yearlyTicketChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container" id="chart-monthly-ticket-section" style="display: none;">
                            <h2 id="monthly-ticket-title">Ticket Médio Mensal</h2>
                            <div class="chart-wrapper">
                                <canvas id="monthlyTicketChart"></canvas>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>

<script>
    const SALES_SPREADSHEET_ID = "1HXyq_r2ssJ5c7wXdrBUc-WdqrlCfiZYE1EuIWbIDg0U";
    const SALES_SHEET_NAME = "ADESOES";
    const METAS_SPREADSHEET_ID = "1KywSOsTn7qUdVp2dLthWD3Y27RsE1aInk6hRJhp7BFw";
    const METAS_SHEET_NAME = "metas";
    const API_KEY = "AIzaSyBuGRH91CnRuDtN5RGsb5DvHEfhTxJnWSs"; 
    
    let allData = [], metasData = new Map(), dataTable, vvrVsMetaPorMesChart, cumulativeVvrChart, monthlyVvrChart, yearlyStackedChart, monthlyStackedChart, yearlyTicketChart, monthlyTicketChart;
    let currentVvrChartType = 'total';
    let currentTableDataType = 'total';
    let currentFilteredDataForTable = [];
    
    const formatCurrency = (value) => new Intl.NumberFormat('pt-br', { style: 'currency', currency: 'BRL' }).format(value || 0);
    const formatPercent = (value) => new Intl.NumberFormat('pt-br', { style: 'percent', minimumFractionDigits: 1 }).format(value || 0);

    document.addEventListener('DOMContentLoaded', async () => {
        const loader = document.getElementById('loader');
        try {
            const [salesData, sheetData] = await Promise.all([fetchAllSalesDataFromSheet(), fetchMetasData()]);
            allData = salesData;
            metasData = sheetData;

            if (allData && allData.length > 0) {
                loader.style.display = 'none';
                ['filters-section', 'kpi-section', 'chart-vvr-mes-section', 'chart-cumulative-section', 'table-section', 
                 'chart-monthly-vvr-section', 'chart-yearly-stacked-section', 'chart-monthly-stacked-section',
                 'chart-yearly-ticket-section', 'chart-monthly-ticket-section' // <-- Tornando visível
                ].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'block';
                });
                document.getElementById('filters-section').style.display = 'flex';
                
                populateFilters();
                addEventListeners();
                updateDashboard();
            } else { loader.innerHTML = 'Nenhum dado de vendas encontrado na planilha.'; }
        } catch (error) { console.error("Erro fatal na inicialização:", error); loader.innerHTML = `Erro ao carregar dados. Verifique o console.`; }
    });

    // ... (O restante do seu JavaScript até a função updateDashboard)

    function updateDashboard() {
        const selectedUnidades = $('#unidade-filter').val() || [];
        const anoVigente = 2025;
        const dataParaGrafico = allData.filter(d => (selectedUnidades.length === 0 || selectedUnidades.includes(d.nm_unidade)) && d.dt_cadastro_integrante.getFullYear() === anoVigente);
        
        // ... (chamadas para os gráficos existentes)
        updateVvrVsMetaPorMesChart(dataParaGrafico, anoVigente);
        updateCumulativeVvrChart(allData, selectedUnidades);
        updateMonthlyVvrChart(allData, selectedUnidades);
        updateDrillDownCharts(allData, selectedUnidades);
        
        // <-- CHAMADA PARA A NOVA FUNÇÃO DOS GRÁFICOS DE TICKET -->
        updateTicketCharts(allData, selectedUnidades);

        const startDateString = document.getElementById('start-date').value;
        const startParts = startDateString.split('-');
        const startDate = new Date(startParts[0], startParts[1] - 1, startParts[2]);
        const endDateString = document.getElementById('end-date').value;
        const endParts = endDateString.split('-');
        const endDate = new Date(endParts[0], endParts[1] - 1, endParts[2]);
        endDate.setDate(endDate.getDate() + 1);
        const dataBrutaFiltrada = allData.filter(d => (selectedUnidades.length === 0 || selectedUnidades.includes(d.nm_unidade)) && d.dt_cadastro_integrante >= startDate && d.dt_cadastro_integrante < endDate);
        updateMainKPIs(dataBrutaFiltrada, selectedUnidades, startDate, endDate);
        const dataAgregadaComVendas = processAndCrossReferenceData(dataBrutaFiltrada);
        const combinedDataMap = new Map();
        dataAgregadaComVendas.forEach(item => { const key = `${item.unidade}-${item.periodo}`; combinedDataMap.set(key, item); });
        const unitsToConsider = selectedUnidades.length > 0 ? selectedUnidades : [...new Set(allData.map(d => d.nm_unidade))];
        metasData.forEach((metaInfo, key) => {
            const [unidade, ano, mes] = key.split('-');
            const metaDate = new Date(ano, parseInt(mes) - 1, 15);
            const periodo = `${ano}-${mes}`;
            const mapKey = `${unidade}-${periodo}`;
            if (unitsToConsider.includes(unidade) && metaDate >= startDate && metaDate < endDate && !combinedDataMap.has(mapKey)) {
                combinedDataMap.set(mapKey, { unidade: unidade, periodo: periodo, realizado_vvr: 0, realizado_adesoes: 0, ...metaInfo });
            }
        });
        const finalTableData = Array.from(combinedDataMap.values());
        currentFilteredDataForTable = finalTableData;
        updateDataTable(finalTableData);
        const startDatePY = new Date(startDate);
        startDatePY.setFullYear(startDatePY.getFullYear() - 1);
        const endDatePY = new Date(endDate);
        endDatePY.setFullYear(endDatePY.getFullYear() - 1);
        const dataBrutaFiltradaPY = allData.filter(d => (selectedUnidades.length === 0 || selectedUnidades.includes(d.nm_unidade)) && d.dt_cadastro_integrante >= startDatePY && d.dt_cadastro_integrante < endDatePY);
        document.getElementById('kpi-section-py').style.display = 'block';
        updatePreviousYearKPIs(dataBrutaFiltradaPY, selectedUnidades, startDatePY, endDatePY);
    }
    
    // ... (todas as suas funções de gráficos existentes permanecem aqui)

    // === NOVAS FUNÇÕES PARA OS GRÁFICOS DE TICKET MÉDIO ===

    function updateTicketCharts(historicalData, selectedUnidades) {
        const unitsToConsider = selectedUnidades.length > 0 ? selectedUnidades : [...new Set(allData.map(d => d.nm_unidade))];
        const filteredHistoricalData = historicalData.filter(d => unitsToConsider.includes(d.nm_unidade));

        const ticketByYear = {};
        filteredHistoricalData.forEach(d => {
            const year = d.dt_cadastro_integrante.getFullYear();
            if (!ticketByYear[year]) {
                ticketByYear[year] = { totalValor: 0, totalAdesoes: 0 };
            }
            ticketByYear[year].totalValor += d.vl_plano;
            ticketByYear[year].totalAdesoes += 1;
        });

        const years = Object.keys(ticketByYear).sort();
        const annualTicketData = years.map(year => {
            const data = ticketByYear[year];
            return data.totalAdesoes > 0 ? data.totalValor / data.totalAdesoes : 0;
        });

        if (yearlyTicketChart) yearlyTicketChart.destroy();
        yearlyTicketChart = new Chart(document.getElementById('yearlyTicketChart'), {
            type: 'bar',
            data: {
                labels: years,
                datasets: [{
                    label: 'Ticket Médio',
                    data: annualTicketData,
                    backgroundColor: '#17a2b8'
                }]
            },
            options: {
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: 'white',
                        font: { weight: 'bold' },
                        formatter: (value) => formatCurrency(value)
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => `Ticket Médio: ${formatCurrency(context.parsed.x)}`
                        }
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const clickedYear = years[elements[0].index];
                        drawMonthlyTicketChart(filteredHistoricalData, clickedYear);
                    }
                }
            }
        });

        if (years.length > 0) {
            drawMonthlyTicketChart(filteredHistoricalData, years[years.length - 1]);
        }
    }

    function drawMonthlyTicketChart(data, year) {
        document.getElementById('monthly-ticket-title').textContent = `Ticket Médio Mensal (${year})`;
        
        const ticketByMonth = Array(12).fill(0).map(() => ({ totalValor: 0, totalAdesoes: 0 }));

        data.forEach(d => {
            if (d.dt_cadastro_integrante.getFullYear() === parseInt(year)) {
                const month = d.dt_cadastro_integrante.getMonth();
                ticketByMonth[month].totalValor += d.vl_plano;
                ticketByMonth[month].totalAdesoes += 1;
            }
        });
        
        const monthlyTicketData = ticketByMonth.map(m => m.totalAdesoes > 0 ? m.totalValor / m.totalAdesoes : 0);
        const monthLabels = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];

        if (monthlyTicketChart) monthlyTicketChart.destroy();
        monthlyTicketChart = new Chart(document.getElementById('monthlyTicketChart'), {
            type: 'bar',
            data: {
                labels: monthLabels,
                datasets: [{
                    label: 'Ticket Médio',
                    data: monthlyTicketData,
                    backgroundColor: '#17a2b8'
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: {
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: 'white',
                        font: { weight: 'bold' },
                        formatter: (value) => formatCurrency(value)
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => `Ticket Médio: ${formatCurrency(context.parsed.y)}`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function updateDataTable(data) { const tableData = data.map(d => { const normalizeText = (text) => text?.trim().toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); let realizado = 0; let meta = 0; const vendasDoPeriodo = allData.filter(v => v.nm_unidade === d.unidade && `${v.dt_cadastro_integrante.getFullYear()}-${String(v.dt_cadastro_integrante.getMonth() + 1).padStart(2, '0')}` === d.periodo); if (currentTableDataType === 'vendas') { realizado = vendasDoPeriodo.filter(v => normalizeText(v.venda_posvenda) === 'VENDA').reduce((sum, v) => sum + v.vl_plano, 0); meta = d.meta_vvr_vendas; } else if (currentTableDataType === 'posvendas') { realizado = vendasDoPeriodo.filter(v => normalizeText(v.venda_posvenda) === 'POS VENDA').reduce((sum, v) => sum + v.vl_plano, 0); meta = d.meta_vvr_posvendas; } else { realizado = d.realizado_vvr; meta = d.meta_vvr_total; } const atingimentoVvr = meta > 0 ? realizado / meta : 0; return [ d.unidade, d.periodo, formatCurrency(realizado), formatCurrency(meta), formatPercent(atingimentoVvr) ]; }).sort((a,b) => String(a[1]).localeCompare(String(b[0]))); if (dataTable) { dataTable.clear().rows.add(tableData).draw(); } else { dataTable = $('#dados-table').DataTable({ data: tableData, pageLength: 10, language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json' }, destroy: true, dom: 'Bfrtip', buttons: [ { extend: 'excelHtml5', text: 'Exportar para Excel', title: `Relatorio_Vendas_${new Date().toLocaleDateString('pt-BR')}`, className: 'excel-button', exportOptions: { format: { body: function ( data, row, column, node ) { if (column === 2 || column === 3) { return parseFloat(data.replace('R$', '').replace(/\./g, '').replace(',', '.').trim()); } if (column === 4) { return parseFloat(data.replace('%', '').replace(',', '.').trim()) / 100; } return data; } } } } ] }); } }
    
    function addEventListeners() { 
        document.getElementById('start-date').addEventListener('change', updateDashboard); 
        document.getElementById('end-date').addEventListener('change', updateDashboard); 
        
        document.querySelectorAll('.page-navigation button').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.page-navigation button').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
                document.getElementById(this.dataset.page).classList.add('active');
            });
        });

        document.querySelectorAll('#chart-vvr-mes-section .chart-selector button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('#chart-vvr-mes-section .chart-selector button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                currentVvrChartType = button.dataset.type;
                updateDashboard();
            });
        });
        document.querySelectorAll('#table-section .chart-selector button').forEach(button => {
            button.addEventListener('click', () => {
                const scrollPosition = window.scrollY;
                document.querySelectorAll('#table-section .chart-selector button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                currentTableDataType = button.dataset.type;
                updateDataTable(currentFilteredDataForTable);
                window.scrollTo(0, scrollPosition);
            });
        });
    }
    
    function populateFilters() { 
        const unidades = [...new Set(allData.map(d => d.nm_unidade))].sort(); 
        const unidadeFilter = $('#unidade-filter'); 
        unidadeFilter.empty(); 
        unidades.forEach(u => { unidadeFilter.append($('<option>', { value: u, text: u })); }); 
        unidadeFilter.multiselect({ 
            enableFiltering: true, 
            includeSelectAllOption: true, 
            selectAllText: 'Marcar todos', 
            filterPlaceholder: 'Pesquisar...', 
            nonSelectedText: 'Todas as unidades', 
            nSelectedText: 'unidades', 
            allSelectedText: 'Todas selecionadas', 
            buttonWidth: '100%', 
            maxHeight: 300,
            onChange: function(option, checked) {
                updateDashboard();
            },
            onSelectAll: function() {
                updateDashboard();
            },
            onDeselectAll: function() {
                updateDashboard();
            }
        }); 
        const hoje = new Date(); 
        const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1); 
        const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0); 
        document.getElementById('start-date').value = inicioMes.toISOString().split('T')[0]; 
        document.getElementById('end-date').value = fimMes.toISOString().split('T')[0]; 
    }

</script>
</body>
</html>
